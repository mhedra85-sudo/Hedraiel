<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0A2A66" />
  <title>Hedra â€“ Teacher Edition</title>
  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="./icon.png" />
  <link rel="apple-touch-icon" href="./icon.png" />
  <link rel="stylesheet" href="./app.css" />
</head>
<body>

<header class="top">
  <div class="wrap">
    <div class="brand">
      <div class="logo">TE</div>
      <div>
        <div style="font-weight:1000;font-size:18px">Hedra â€“ Teacher Edition</div>
        <div class="hint" id="topDate">â€”</div>
        <div class="rowWrap" style="gap:8px">
          <span class="badge" id="topSession">Ø§Ù„Ø­ØµØ©: â€”</span>
          <span class="badge" id="topCycle">Ø§Ù„Ø¯ÙˆØ±Ø©: â€”</span>
          <span class="badge" id="topRole">Ø§Ù„Ø¯ÙˆØ±: Ù…Ø¯ÙŠØ±</span>
          <span class="badge">v6.1.0-pro</span>
        </div>
      </div>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
      <button class="btn small noPrint" id="btnInstall" style="display:none">â¬‡ ØªØ«Ø¨ÙŠØª</button>
      <button class="btn small ghost noPrint" id="btnExport">â¬† ØªØµØ¯ÙŠØ± Ù…Ø´ÙÙ‘Ø±</button>
      <button class="btn small ghost noPrint" id="btnImport">â¬‡ Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
    </div>
  </div>
</header>

<main class="page">
  <section id="pageRun">
    <div class="card">
      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-start">
        <div>
          <div style="font-weight:1000;font-size:16px">Ø§Ù„Ø­ØµØ©</div>
          <div class="hint">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ + Ø§Ù„Ø¯ÙØ¹ + Ø§Ù„Ø­Ø¶ÙˆØ±.</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn small ghost noPrint" id="btnScanQR">ğŸ“· Ù…Ø³Ø­ QR</button>
          <button class="btn small royal noPrint" id="btnAddSession">ï¼‹ Ø¥Ø¶Ø§ÙØ© Ø­ØµØ©</button>
          <button class="btn small danger noPrint" id="btnRemoveSession">âˆ’ Ø­Ø°Ù Ø¢Ø®Ø± Ø­ØµØ©</button>
        </div>
      </div>
      <div class="hr"></div>
      <label for="selGroupRun">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
      <select id="selGroupRun"></select>
      <div class="hr"></div>
      <div class="list" id="runList"></div>
    </div>
  </section>

  <section id="pageManage" style="display:none">
    <div class="card">
      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-start">
        <div>
          <div style="font-weight:1000;font-size:16px">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
          <div class="hint">Ø¨Ø­Ø« + Ù…Ù„Ø®Øµ + ØªØ¯Ù‚ÙŠÙ‚ + Ø¥ÙŠØµØ§Ù„Ø§Øª.</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn small ghost noPrint" id="btnBulk">ğŸ“¥ Ø¥Ù†Ø´Ø§Ø¡ Ø­ØµØµ Ù‚Ø¯ÙŠÙ…Ø©</button>
          <button class="btn small ghost noPrint" id="btnAudit">ğŸ§¾ ØªØ¯Ù‚ÙŠÙ‚</button>
          <button class="btn small ghost noPrint" id="btnReceipts">ğŸ§¾ Ø¥ÙŠØµØ§Ù„Ø§Øª</button>
        </div>
      </div>

      <div class="hr"></div>
      <label for="qManage">Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… (ÙƒÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª)</label>
      <input id="qManage" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨..." />
      <div class="hr"></div>
      <label for="selGroupManage">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
      <select id="selGroupManage"></select>
      <div class="hr"></div>
      <div class="list" id="manageList"></div>
    </div>
  </section>

  <section id="pageDashboard" style="display:none">
    <div class="card">
      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-start">
        <div>
          <div style="font-weight:1000;font-size:16px">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
          <div class="hint">Ù…Ù„Ø®Øµ + Ø¯Ø®Ù„ Ø´Ù‡Ø±ÙŠ + Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØ£Ø®Ø±ÙŠÙ†.</div>
        </div>
        <button class="btn small ghost noPrint" id="btnDashPrint">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø©</button>
      </div>
      <div class="hr"></div>
      <div class="rowWrap" id="dashCards"></div>
      <div class="hr"></div>
      <div id="dashMonth"></div>
      <div class="hr"></div>
      <div style="font-weight:1000;margin-bottom:6px">ğŸ“ˆ Ù†Ù…Ùˆ Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø´Ù‡Ø±ÙŠ</div>
      <canvas id="incomeCanvas" width="980" height="260" style="width:100%;border-radius:22px;border:1px solid rgba(2,6,23,.12);box-shadow:var(--shadow2);background:#fff"></canvas>
      <div class="hr"></div>
      <div style="font-weight:1000;margin-bottom:6px">ğŸ“‰ Ø§Ù„ØºÙŠØ§Ø¨ Ø´Ù‡Ø±ÙŠÙ‹Ø§</div>
      <canvas id="absenceCanvas" width="980" height="260" style="width:100%;border-radius:22px;border:1px solid rgba(2,6,23,.12);box-shadow:var(--shadow2);background:#fff"></canvas>
      <div class="hr"></div>
      <div class="list" id="dashLate"></div>
    </div>
  </section>

  <section id="pageSettings" style="display:none">
    <div class="card">
      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-start">
        <div>
          <div style="font-weight:1000;font-size:16px">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
          <div class="hint">Ù…Ø¬Ù…ÙˆØ¹Ø§Øª + Ø·Ù„Ø§Ø¨ + Ø£Ø³Ø¹Ø§Ø± + Ø®ØµÙˆÙ…Ø§Øª + Ø£Ù…Ø§Ù†.</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn small royal noPrint" id="btnAddGroup">ï¼‹ Ù…Ø¬Ù…ÙˆØ¹Ø©</button>
          <button class="btn small ghost noPrint" id="btnNewCycle">ğŸ” Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
          <button class="btn small ghost noPrint" id="btnChangePIN">ğŸ”’ ØªØºÙŠÙŠØ± PIN</button>
        </div>
      </div>

      <div class="hr"></div>
      <label for="selGroupSettings">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
      <select id="selGroupSettings"></select>

      <div class="rowWrap">
        <div>
          <label for="cycleLen">Ù…Ø¯Ø© Ø§Ù„Ø¯ÙˆØ±Ø© (Ø¹Ø¯Ø¯ Ø§Ù„Ø­ØµØµ)</label>
          <select id="cycleLen">
            <option value="4">4</option><option value="8" selected>8</option><option value="12">12</option>
          </select>
        </div>
        <div>
          <label for="chargeMode">Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</label>
          <select id="chargeMode">
            <option value="perSessions" selected>Ø­Ø³Ø¨ Ø§Ù„Ø­ØµØµ</option>
            <option value="byAttendance">Ø­Ø³Ø¨ Ø§Ù„Ø­Ø¶ÙˆØ±</option>
          </select>
        </div>
      </div>

      <div class="rowWrap">
        <div>
          <label for="brandName">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…/Ø§Ù„Ù…Ø±ÙƒØ² ÙÙŠ Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª</label>
          <input id="brandName" placeholder="Ù…Ø«Ø§Ù„: Ø£/ Ø£Ø­Ù…Ø¯" />
        </div>
        <div>
          <label for="brandPhone">Ù‡Ø§ØªÙ/ÙˆØ§ØªØ³Ø§Ø¨</label>
          <input id="brandPhone" placeholder="01xxxxxxxxx" />
        </div>
      </div>


      <div class="hr"></div>
      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-start">
        <div>
          <div style="font-weight:1000">â˜ï¸ Ø§Ù„ØªØ²Ø§Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ (PRO)</div>
          <div class="hint">ÙŠØ±ÙØ¹ "Ø§Ù„Ø®Ø²Ù†Ø© Ø§Ù„Ù…Ø´ÙØ±Ø©" ÙƒÙ…Ø§ Ù‡ÙŠ (Encrypted Vault) Ù„Ø­Ù…Ø§ÙŠØªÙ‡Ø§ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…ØªØµÙØ­. ÙŠØ­ØªØ§Ø¬ Ø¥Ù†ØªØ±Ù†Øª.</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap" class="noPrint">
          <button class="btn small ghost" id="btnCloudUpload">â¬† Ø±ÙØ¹ Ø§Ù„Ø¢Ù†</button>
          <button class="btn small ghost" id="btnCloudDownload">â¬‡ Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button>
        </div>
      </div>

      <div class="rowWrap">
        <div>
          <label for="cloudProvider">Ù…Ø²ÙˆØ¯ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</label>
          <select id="cloudProvider">
            <option value="none" selected>Ø¨Ø¯ÙˆÙ†</option>
            <option value="drive">Google Drive (Files API)</option>
            <option value="dropbox">Dropbox</option>
          </select>
        </div>
        <div>
          <label for="cloudFileName">Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</label>
          <input id="cloudFileName" placeholder="Ù…Ø«Ø§Ù„: HedraVault.json" />
        </div>
      </div>

      <div class="rowWrap">
        <div style="flex:2;min-width:260px">
          <label for="cloudToken">Access Token</label>
          <input id="cloudToken" placeholder="Ø§Ù„ØµÙ‚ Access Token Ù‡Ù†Ø§ (OAuth)"/>
          <div class="hint">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¨Ø¯ÙˆÙ† Ø®Ø§Ø¯Ù… (Server) Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªÙˆÙƒÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†. Ø³ØªØ¶Ø¹Ù‡ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø«Ù… ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ø³Ø­Ù‡.</div>
        </div>
        <div style="flex:1;min-width:220px">
          <label for="cloudAuto">Ø±ÙØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠ</label>
          <select id="cloudAuto">
            <option value="off" selected>Ø¥ÙŠÙ‚Ø§Ù</option>
            <option value="on">ØªØ´ØºÙŠÙ„</option>
          </select>
        </div>
      </div>

      <div class="hr"></div>
      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-start">
        <div>
          <div style="font-weight:1000">ğŸ” ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø³Ø§Ø¹Ø¯ Ø­Ù‚ÙŠÙ‚ÙŠØ© (PRO)</div>
          <div class="hint">ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ "Ù†Ø³Ø®Ø© Ù…Ø³Ø§Ø¹Ø¯" Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ø¨Ø§Ø­/Ù…Ø¯ÙÙˆØ¹Ø§Øª/Ø£Ø³Ø¹Ø§Ø±. Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ ÙŠÙØªØ­Ù‡Ø§ Ø¨Ù€ PIN Ø®Ø§Øµ.</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap" class="noPrint">
          <button class="btn small ghost" id="btnMakeAssistant">ğŸ§© Ø¥Ù†Ø´Ø§Ø¡/ØªØ­Ø¯ÙŠØ« Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯</button>
        </div>
      </div>
<div class="hr"></div>
      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-end">
        <div>
          <div style="font-weight:1000">Ø§Ù„Ø·Ù„Ø§Ø¨</div>
          <div class="hint">Ø§Ù„Ø­Ø°Ù = Ø£Ø±Ø´ÙØ© (Ù„Ø§ Ø¶ÙŠØ§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª).</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <input id="newStudentName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨..." style="min-width:220px"/>
          <button class="btn small royal noPrint" id="btnAddStudent">ï¼‹ Ø¥Ø¶Ø§ÙØ©</button>
        </div>
      </div>
      <div class="hr"></div>
      <div class="list" id="studentsList"></div>
    </div>
  </section>
</main>

<nav class="bottom noPrint">
  <div class="wrap">
    <button class="tab active" data-tab="run">ğŸ </button>
    <button class="tab" data-tab="manage">ğŸ§¾</button>
    <button class="tab" data-tab="dashboard">ğŸ“Š</button>
    <button class="tab" data-tab="settings">âš™ï¸</button>
  </div>
</nav>

<div class="overlay" id="lockOverlay" style="display:block">
  <div class="modal" style="max-width:520px">
    <div style="text-align:center">
      <img src="icon.png" alt="" style="width:92px;height:92px;border-radius:28px;box-shadow:var(--shadow2)"/>
      <div style="font-weight:1000;font-size:20px;margin-top:10px">Hedra Teacher Edition</div>
      <div class="hint" id="lockHint">Ø£Ø¯Ø®Ù„ PIN (4 Ø£Ø±Ù‚Ø§Ù… Ø£Ùˆ Ø£ÙƒØ«Ø±)</div>
    </div>
    <div class="hr"></div>
    <label for="pinInput">PIN</label>
    <input id="pinInput" inputmode="numeric" autocomplete="off" placeholder="â€¢â€¢â€¢â€¢" />
    <div class="rowWrap noPrint" style="margin-top:10px">
      <button class="btn small ghost" id="roleAdmin">Ù…Ø¯ÙŠØ±</button>
      <button class="btn small ghost" id="roleAssistant">Ù…Ø³Ø§Ø¹Ø¯</button>
      <button class="btn small ghost" id="roleView">Ø¹Ø±Ø¶ ÙÙ‚Ø·</button>
    </div>
    <div class="rowWrap noPrint" style="margin-top:10px">
      <button class="btn small royal" id="btnUnlock">ÙØªØ­</button>
      <button class="btn small ghost" id="btnLockClear">Ù…Ø³Ø­</button>
    </div>
    <div class="hr"></div>
    <div class="hint">Ù†Ø³Ø®Ø© ØªØ¬Ø§Ø±ÙŠØ©: Ø¥ÙŠØµØ§Ù„Ø§Øª + ØªØ¯Ù‚ÙŠÙ‚ + Ø£Ø±Ø´ÙØ© + ØªØµØ¯ÙŠØ± Ù…Ø´ÙÙ‘Ø± + Ù…Ù†Ø¹ Ø§Ù„Ø®ØµÙ… Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø¯ÙÙˆØ¹.</div>
  </div>
</div>

<div class="overlay" id="payOverlay">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
      <div>
        <div style="font-weight:1000" id="payTitle">â€”</div>
        <div class="hint" id="paySub">â€”</div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap" class="noPrint">
        <button class="btn small ghost" id="btnPayReceipt">ğŸ§¾ Ø¥ÙŠØµØ§Ù„</button>
        <button class="btn small ghost" id="btnPayPrint">ğŸ–¨</button>
        <button class="btn small ghost" id="btnPayClose">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
    <div class="hr"></div>
    <div id="payBody"></div>
    <div class="hr"></div>
    <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center">
      <div>
        <div style="font-weight:1000">QR Ø§Ù„Ø·Ø§Ù„Ø¨</div>
        <div class="hint">Ø§Ø³ØªØ®Ø¯Ù…Ù‡ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ø³Ø±Ø¹Ø©.</div>
      </div>
      <button class="btn small ghost noPrint" id="btnShowQR">ğŸ“ Ø¹Ø±Ø¶ QR</button>
    </div>
    <div style="display:none;margin-top:10px" id="qrWrap">
      <canvas id="qrCanvas" width="220" height="220" style="border-radius:18px;border:1px solid rgba(2,6,23,.12);box-shadow:var(--shadow2);background:#fff"></canvas>
      <div class="hint" style="margin-top:8px">ÙŠÙ…ÙƒÙ†Ùƒ Ø·Ø¨Ø§Ø¹Ø©/ØªØµÙˆÙŠØ± Ø§Ù„Ù€ QR ÙˆÙ…Ø´Ø§Ø±ÙƒØªÙ‡.</div>
    </div>
    <div class="hr"></div>
    <div class="rowWrap noPrint" id="payBtns">
      <button class="btn small royal" id="btnPaySet">âœ ØªØ¹Ø¯ÙŠÙ„</button>
      <button class="btn small ghost" id="btnPayAdd">ï¼‹ Ø¥Ø¶Ø§ÙØ©</button>
      <button class="btn small ghost" id="btnPayMinus">âˆ’ Ø®ØµÙ…</button>
    </div>
    <div class="rowWrap noPrint" id="payAmountWrap" style="display:none;margin-top:10px">
      <div style="flex:2;min-width:220px">
        <label id="payAmountLabel">Ø§Ù„Ù…Ø¨Ù„Øº</label>
        <input id="payAmount" type="number" step="1" />
      </div>
      <div style="flex:1;min-width:160px;align-self:flex-end">
        <button class="btn small royal" id="btnPayApply">âœ… ØªØ·Ø¨ÙŠÙ‚</button>
      </div>
    </div>
    <div class="hr"></div>
    <label for="payNote">Ù…Ù„Ø§Ø­Ø¸Ø©</label>
    <input id="payNote" />
    <div class="rowWrap noPrint" style="margin-top:10px">
      <button class="btn small royal" id="btnPaySaveNote">ğŸ’¾ Ø­ÙØ¸</button>
    </div>
    <div class="hr"></div>
    <div class="hint">Ø§Ù„Ø­Ø¶ÙˆØ±/Ø§Ù„ØºÙŠØ§Ø¨:</div>
    <div class="list" id="attList"></div>
  </div>
</div>

<div class="overlay" id="bulkOverlay"><div class="modal">
  <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
    <div><div style="font-weight:1000">ğŸ“¥ Ø¥Ù†Ø´Ø§Ø¡ Ø­ØµØµ Ù‚Ø¯ÙŠÙ…Ø©</div><div class="hint">Ø§Ø®ØªÙŠØ§Ø± Ù†Ø·Ø§Ù‚ + Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ (0=Ø§Ù„Ø£Ø­Ø¯ â€¦ 6=Ø§Ù„Ø³Ø¨Øª).</div></div>
    <button class="btn small ghost noPrint" id="btnBulkClose">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
  <div class="hr"></div>
  <div class="rowWrap">
    <div><label>Ù…Ù†</label><input id="bulkFrom" type="date"></div>
    <div><label>Ø¥Ù„Ù‰</label><input id="bulkTo" type="date"></div>
  </div>
  <div class="hr"></div>
  <div class="rowWrap" style="gap:8px">
    <label style="display:flex;gap:8px;align-items:center"><input class="dow" type="checkbox" value="0">Ø§Ù„Ø£Ø­Ø¯</label>
    <label style="display:flex;gap:8px;align-items:center"><input class="dow" type="checkbox" value="1">Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†</label>
    <label style="display:flex;gap:8px;align-items:center"><input class="dow" type="checkbox" value="2">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</label>
    <label style="display:flex;gap:8px;align-items:center"><input class="dow" type="checkbox" value="3">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</label>
    <label style="display:flex;gap:8px;align-items:center"><input class="dow" type="checkbox" value="4">Ø§Ù„Ø®Ù…ÙŠØ³</label>
    <label style="display:flex;gap:8px;align-items:center"><input class="dow" type="checkbox" value="5">Ø§Ù„Ø¬Ù…Ø¹Ø©</label>
    <label style="display:flex;gap:8px;align-items:center"><input class="dow" type="checkbox" value="6">Ø§Ù„Ø³Ø¨Øª</label>
  </div>
  <div class="hr"></div>
  <button class="btn small royal noPrint" id="btnBulkApply">âœ… Ø¥Ù†Ø´Ø§Ø¡</button>
</div></div>

<div class="overlay" id="auditOverlay"><div class="modal">
  <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
    <div><div style="font-weight:1000">ğŸ§¾ Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</div><div class="hint">Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø© (Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·).</div></div>
    <div class="noPrint" style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn small ghost" id="btnAuditCSV">â¬† CSV</button>
      <button class="btn small ghost" id="btnAuditClose">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
  <div class="hr"></div>
  <pre id="auditText" class="hint" style="white-space:pre-wrap;margin:0">â€”</pre>
</div></div>

<div class="overlay" id="rcOverlay"><div class="modal">
  <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
    <div><div style="font-weight:1000">ğŸ§¾ Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª</div><div class="hint">Ø·Ø¨Ø§Ø¹Ø© + CSV.</div></div>
    <div class="noPrint" style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn small ghost" id="btnRcCSV">â¬† CSV</button>
      <button class="btn small ghost" id="btnRcClose">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
  <div class="hr"></div>
  <div id="rcList"></div>
</div></div>


<div class="overlay" id="qrOverlay"><div class="modal" style="max-width:720px">
  <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
    <div>
      <div style="font-weight:1000">ğŸ“· Ù…Ø³Ø­ QR Ù„Ù„Ø­Ø¶ÙˆØ±</div>
      <div class="hint">ÙˆØ¬Ù‘Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù†Ø­Ùˆ QR Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ø­ØµØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©.</div>
    </div>
    <div class="noPrint" style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn small ghost" id="btnQRStop">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
  <div class="hr"></div>
  <div id="qrWarn" class="hint">â€”</div>
  <div style="position:relative;margin-top:10px">
    <video id="qrVideo" autoplay playsinline style="width:100%;border-radius:22px;border:1px solid rgba(2,6,23,.12);box-shadow:var(--shadow2);background:#000"></video>
    <canvas id="qrScanCanvas" style="display:none"></canvas>
  </div>
</div></div>

<div class="toast" id="toast"></div>

<div class="overlay" id="printOverlay" style="display:none">
  <div class="modal" style="max-width:980px;width:min(980px,96vw)">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <div>
        <div style="font-weight:1000">ğŸ§¾ Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</div>
        <div class="hint" id="printMeta">â€”</div>
      </div>
      <div class="noPrint" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <label class="chip" style="display:flex;gap:8px;align-items:center">
          <input type="checkbox" id="toggleShortInvoice" />
          ÙØ§ØªÙˆØ±Ø© Ù…Ø®ØªØµØ±Ø©
        </label>
        <button class="btn small ghost" id="btnPrintDownloadHtml">â¬‡ï¸ HTML</button>
        <button class="btn small ghost" id="btnPrintPdf">ğŸ“„ PDF</button>
        <button class="btn small royal" id="btnPrintNow">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø©</button>
        <button class="btn small ghost" id="btnPrintClose">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
    <div class="hr"></div>
    <iframe id="printFrame" style="width:100%;height:min(70vh,720px);border:1px solid rgba(0,0,0,.12);border-radius:14px;background:#fff"></iframe>
    <div class="hint" style="margin-top:10px">
      Ù…Ù„Ø§Ø­Ø¸Ø©: Ø²Ø± PDF ÙŠØ³ØªØ®Ø¯Ù… Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù„Ø­ÙØ¸ "Save as PDF" Ù„Ø¶Ù…Ø§Ù† Ø¯Ø¹Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø¯Ù‚Ø©.
    </div>
  </div>
</div>

");
    w.document.close();
  };

  function renderAttendance(g,c,s){
    const wrap=$("attList"); wrap.innerHTML="";
    if(!c.sessions.length){ wrap.innerHTML='<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ Ø¨Ø¹Ø¯.</div>'; return; }
    c.sessions.forEach(ss=>{
      const y=ymdFromTs(ss.tsISO);
      const val=c.attendance?.[ss.id]?.[s.id]||"";
      const label= val==="P" ? "Ø­Ø¶ÙˆØ± âœ…" : val==="A" ? "ØºÙŠØ§Ø¨ âŒ" : "â€”";
      const row=document.createElement("div"); row.className="row";
      row.innerHTML=`<div class="left"><div class="num">ğŸ—“</div><div><div class="name">${fmtDMY(y)}</div><div class="mini">${y}</div></div></div>
        <button class="btn small ghost noPrint">${label}</button>`;
      row.querySelector("button").onclick=async ()=>{
        if(role===ROLE.VIEW) return toast("Ø¹Ø±Ø¶ ÙÙ‚Ø·");
        c.attendance=c.attendance||{}; c.attendance[ss.id]=c.attendance[ss.id]||{};
        const cur=c.attendance[ss.id][s.id]||"";
        const next = cur==="P" ? "A" : cur==="A" ? "" : "P";
        if(!next) delete c.attendance[ss.id][s.id]; else c.attendance[ss.id][s.id]=next;
        auditAdd("attendance.toggle",{studentId:s.id, ymd:y, val:next||"â€”"});
        await save();
        openPay(g,c,s);
        render();
      };
      wrap.appendChild(row);
    });
  }

  // audit / receipts overlays
  const closeOverlay=(id)=>$(id).style.display="none";
  const openOverlay=(id)=>$(id).style.display="block";

  $("btnQRStop").onclick=stopQRScanner;
  $("qrOverlay").addEventListener("click",(e)=>{ if(e.target===$("qrOverlay")) stopQRScanner(); });


  $("btnAudit").onclick=()=>{
    if(role!==ROLE.ADMIN) return toast("Ù„Ù„Ù€ Ù…Ø¯ÙŠØ± ÙÙ‚Ø·");
    const g=curGroup();
    $("auditText").textContent=(g.audit||[]).slice(-500).reverse().map(a=>a.tsISO+" | "+a.role+" | "+a.action+" | "+JSON.stringify(a.meta||{})).join("\n")||"â€”";
    openOverlay("auditOverlay");
  };
  $("btnAuditClose").onclick=()=>closeOverlay("auditOverlay");
  $("auditOverlay").addEventListener("click",(e)=>{ if(e.target===$("auditOverlay")) closeOverlay("auditOverlay"); });
  $("btnAuditCSV").onclick=()=>{ downloadText("Hedra_Audit_"+isoYMD(new Date())+".csv", auditCSV(), "text/csv;charset=utf-8"); toast("ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±"); };

  $("btnReceipts").onclick=()=>{
    if(role!==ROLE.ADMIN) return toast("Ù„Ù„Ù€ Ù…Ø¯ÙŠØ± ÙÙ‚Ø·");
    const list=allReceipts().slice(0,250);
    const wrap=$("rcList");
    if(!list.length) wrap.innerHTML='<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥ÙŠØµØ§Ù„Ø§Øª.</div>';
    else wrap.innerHTML=list.map(x=>`<div class="row"><div class="left"><div class="num">ğŸ§¾</div><div><div class="name">${escapeHtml(x.r.rid)} â€¢ ${escapeHtml(x.r.studentName)}</div><div class="mini">${escapeHtml(x.g.name)} â€¢ ${x.r.amount}</div></div></div><button class="moreBtn noPrint" data-rid="${escapeHtml(x.r.rid)}">Ø·Ø¨Ø§Ø¹Ø©</button></div>`).join("");
    wrap.querySelectorAll("button[data-rid]").forEach(b=>b.onclick=()=>{
      const rid=b.getAttribute("data-rid");
      const f=allReceipts().find(x=>x.r.rid===rid); if(!f) return;
      const w=window.open("","_blank");
      w.document.write("<meta charset='utf-8'><title>"+rid+"</title>"+receiptPrintHTML(f.r,f.g.name)+"");
      w.document.close();
    });
    openOverlay("rcOverlay");
  };
  $("btnRcClose").onclick=()=>closeOverlay("rcOverlay");
  $("rcOverlay").addEventListener("click",(e)=>{ if(e.target===$("rcOverlay")) closeOverlay("rcOverlay"); });
  $("btnRcCSV").onclick=()=>{ downloadText("Hedra_Receipts_"+isoYMD(new Date())+".csv", receiptsCSV(), "text/csv;charset=utf-8"); toast("ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±"); };

  // Export / Import (encrypted backup)
  $("btnExport").onclick=async ()=>{
    if(role!==ROLE.ADMIN) return toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­");
    const pass=prompt("ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„ØªØµØ¯ÙŠØ± (4+ Ø£Ø­Ø±Ù/Ø£Ø±Ù‚Ø§Ù…)"); if(!pass||String(pass).trim().length<4) return;
    const salt=crypto.getRandomValues(new Uint8Array(16));
    const key=await deriveKeyFromPIN(String(pass).trim(), salt.buffer);
    const packed=await encryptJSON(key, {type:"hedra_export", ver:"6.0-teacher", exportedAt:new Date().toISOString(), db});
    const out={type:"hedra_export", v:2, saltB64:bufToB64(salt.buffer), ...packed};
    downloadText("Hedra_V6_Teacher_Encrypted_Backup_"+isoYMD(new Date())+".json", JSON.stringify(out,null,2), "application/json;charset=utf-8");
    toast("ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±");
  };
  $("btnImport").onclick=()=>{
    if(role!==ROLE.ADMIN) return toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­");
    const inp=document.createElement("input"); inp.type="file"; inp.accept="application/json";
    inp.onchange=()=>{
      const f=inp.files?.[0]; if(!f) return;
      const r=new FileReader();
      r.onload=()=>{ (async ()=>{
        try{
          const parsed=JSON.parse(String(r.result||""));
          let next=null;
          if(parsed?.type==="hedra_export" && parsed?.v===2){
            const pass=prompt("ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©"); if(!pass) return;
            const key=await deriveKeyFromPIN(String(pass).trim(), b64ToBuf(parsed.saltB64));
            next=await decryptJSON(key, parsed.ivB64, parsed.ctB64);
            next=next?.db ?? next;
          } else {
            next=parsed;
          }
          db=ensureDefaults(next);
          await save(); toast("ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯"); render();
        }catch(e){ alert("ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯"); }
      })(); };
      r.readAsText(f);
    };
    inp.click();
  };

  // Change PIN (admin only)
  $("btnChangePIN").onclick=async ()=>{
    if(role!==ROLE.ADMIN) return toast("Ù„Ù„Ù€ Ù…Ø¯ÙŠØ± ÙÙ‚Ø·");
    if(!sessionKey) return toast("Ø§ÙØªØ­ Ø£ÙˆÙ„Ø§Ù‹");
    const old=prompt("PIN Ø§Ù„Ø­Ø§Ù„ÙŠ"); if(!old) return;
    try{
      // verify old by trying to decrypt vault
      const raw=localStorage.getItem(DB_KEY); if(!raw) return toast("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø²Ù†Ø©");
      const v=JSON.parse(raw);
      const key=await deriveKeyFromPIN(String(old).trim(), b64ToBuf(v.saltB64));
      await decryptJSON(key, v.ivB64, v.ctB64); // verify
      const np=prompt("PIN Ø¬Ø¯ÙŠØ¯ (4+ Ø£Ø±Ù‚Ø§Ù…)"); if(!np||String(np).trim().length<4) return;
      // re-encrypt with new salt
      const salt=crypto.getRandomValues(new Uint8Array(16));
      saltB64=bufToB64(salt.buffer);
      sessionKey=await deriveKeyFromPIN(String(np).trim(), salt.buffer);
      await save();
      toast("ØªÙ… ØªØºÙŠÙŠØ± PIN");
      auditAdd("security.pin.change",{});
      await save();
    }catch(e){ toast("PIN Ø§Ù„Ø­Ø§Ù„ÙŠ Ø®Ø·Ø£"); }
  };

  // Lock / Unlock
  const openLock=(msg)=>{ $("lockHint").textContent=msg; $("lockOverlay").style.display="block"; };
  const closeLock=()=>{ $("lockOverlay").style.display="none"; $("pinInput").value=""; };
  $("btnLockClear").onclick=()=>$("pinInput").value="";
  $("roleAdmin").onclick=()=>{ role=ROLE.ADMIN; toast("Ù…Ø¯ÙŠØ±"); renderTop(); };
  $("roleAssistant").onclick=()=>{ role=ROLE.ASSISTANT; toast("Ù…Ø³Ø§Ø¹Ø¯"); renderTop(); };
  $("roleView").onclick=()=>{ role=ROLE.VIEW; toast("Ø¹Ø±Ø¶ ÙÙ‚Ø·"); renderTop(); };

  $("btnUnlock").onclick=async ()=>{
    const btn=$("btnUnlock");
    btn.disabled=true;
    btn.style.opacity="0.7";
    try{
      const pin=String($("pinInput").value||"").trim();
      if(pin.length<4) return toast("PIN Ù‚ØµÙŠØ±");
      const now=Date.now();
      const lockUntil=Number(db.settings.pinLockUntil||0);
      if(lockUntil && now<lockUntil) return toast("Ù…Ù‚ÙÙˆÙ„ Ù…Ø¤Ù‚ØªÙ‹Ø§");
      toast("Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØªØ­...");
      if(role===ROLE.ADMIN){
        if(!hasVault()) {
          await setupNew(pin);
        } else {
          const loaded=await load(pin);
          if(!loaded) throw new Error("bad");
          db.settings.pinFailCount=0; db.settings.pinLockUntil=0;
          await save();
        }
      } else {
        // assistant/view uses assistant vault (no money data)
        const loaded=await loadAssistant(pin);
        if(!loaded) throw new Error("bad");
      }
      setUnlocked(true);
      closeLock();
      render();
      toast("ØªÙ… Ø§Ù„ÙØªØ­");
    }catch(e){
      console.error(e);
      if(String(e&&e.message||e)==="NO_ASSIST_VAULT"){ toast("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø®Ø© Ù…Ø³Ø§Ø¹Ø¯. Ø§Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù…Ø¯ÙŠØ± Ø¥Ù†Ø´Ø§Ø¡Ù‡Ø§."); $("pinInput").value=""; return; }
      db.settings.pinFailCount = Number(db.settings.pinFailCount||0)+1;
      if(db.settings.pinFailCount>=5) {
        db.settings.pinLockUntil = Date.now()+30000;
        db.settings.pinFailCount=0;
        toast("Ù‚ÙÙ„ 30 Ø«Ø§Ù†ÙŠØ©");
      } else toast("PIN Ø®Ø·Ø£");
      $("pinInput").value="";
    } finally {
      btn.disabled=false;
      btn.style.opacity="1";
    }
  };

  // auto-lock (10 min) + wipe memory
  setInterval(()=>{
    if(!isUnlocked()) return;
    const last=Number(sessionStorage.getItem("hedra_last_active")||0);
    if(last && Date.now()-last>10*60*1000){
      setUnlocked(false);
      db=ensureDefaults(makeEmptyDB());
      sessionKey=null; saltB64=null;
      openLock("ØªÙ… Ø§Ù„Ù‚ÙÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§");
    }
  }, 4000);
  ["click","keydown","touchstart","mousemove"].forEach(ev=>window.addEventListener(ev,()=>touch(),{passive:true}));

  // PWA install
  let deferred=null;
  window.addEventListener("beforeinstallprompt",(e)=>{ e.preventDefault(); deferred=e; $("btnInstall").style.display="inline-flex"; });
  $("btnInstall").onclick=async ()=>{ if(!deferred) return alert("Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© â‹® Ø«Ù… Install"); deferred.prompt(); await deferred.userChoice; deferred=null; $("btnInstall").style.display="none"; };

  // SW
  if("serviceWorker" in navigator) navigator.serviceWorker.register("sw.js?v="+BUILD);


  // PRO: Assistant vault (true privacy: no txs/prices/audit)
  async function makeAssistantSnapshot(){
    if(role!==ROLE.ADMIN) return toast("Ù„Ù„Ù€ Ù…Ø¯ÙŠØ± ÙÙ‚Ø·");
    const ap=prompt("PIN Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ (4+ Ø£Ø±Ù‚Ø§Ù…) Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø¨Ø¯ÙˆÙ† Ø£Ø±Ø¨Ø§Ø­"); if(!ap||String(ap).trim().length<4) return;
    const salt=crypto.getRandomValues(new Uint8Array(16));
    const key=await deriveKeyFromPIN(String(ap).trim(), salt.buffer);

    const red=deepClone(db);
    // redact money-sensitive fields
    red.groups.forEach(g=>{
      g.audit=[];
      g.students.forEach(s=>{
        s.price=0; s.discountType="none"; s.discountValue=0;
      });
      g.cycles.forEach(c=>{
        c.txs=[];
        c.receipts=[];
        c.carry={}; // hide carry balances
      });
    });
    const packed=await encryptJSON(key, {type:"hedra_assistant", ver:"6.1-pro", createdAt:new Date().toISOString(), db:red});
    localStorage.setItem(DB_KEY_ASSIST, JSON.stringify({type:"hedra_assistant", v:1, saltB64:bufToB64(salt.buffer), ...packed}));
    db.settings.assistant.enabled=true;
    await save(); // save admin vault (flag only)
    toast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯");
    auditAdd("assistant.snapshot",{});
    await save();
  }

  async function loadAssistant(pin){
    const raw=localStorage.getItem(DB_KEY_ASSIST);
    if(!raw) throw new Error("NO_ASSIST_VAULT");
    const v=JSON.parse(raw);
    const key=await deriveKeyFromPIN(String(pin||"").trim(), b64ToBuf(v.saltB64));
    const loaded=ensureDefaults(await decryptJSON(key, v.ivB64, v.ctB64));
    // assistant mode uses its own sessionKey to save assistant vault only (no admin vault access)
    sessionKey=key;
    saltB64=v.saltB64;
    db=loaded;
    return db;
  }

  async function saveAssistantVault(){
    if(role===ROLE.ASSISTANT || role===ROLE.VIEW){
      const packed=await encryptJSON(sessionKey, db);
      localStorage.setItem(DB_KEY_ASSIST, JSON.stringify({type:"hedra_assistant", v:1, saltB64, ...packed}));
    }
  }

  // PRO: Cloud Sync (uploads encrypted vault JSON as-is)
  async function cloudUpload(){
    const prov=db.settings.cloud.provider;
    const token=String(db.settings.cloud.token||"").trim();
    const fileName=String(db.settings.cloud.fileName||"HedraVault.json").trim()||"HedraVault.json";
    if(prov==="none") return toast("Ø§Ø®ØªØ± Ù…Ø²ÙˆØ¯");
    if(!token) return alert("Ø¶Ø¹ Access Token ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª");
    // pick correct local payload (admin or assistant)
    const payload = (role===ROLE.ADMIN) ? localStorage.getItem(DB_KEY) : localStorage.getItem(DB_KEY_ASSIST);
    if(!payload) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø²Ù†Ø© Ù„Ø±ÙØ¹Ù‡Ø§");
    const blob=new Blob([payload],{type:"application/json"});
    if(prov==="dropbox"){
      const res=await fetch("https://content.dropboxapi.com/2/files/upload",{
        method:"POST",
        headers:{
          "Authorization":"Bearer "+token,
          "Dropbox-API-Arg": JSON.stringify({path:"/"+fileName, mode:"overwrite", autorename:false, mute:true}),
          "Content-Type":"application/octet-stream"
        },
        body: await blob.arrayBuffer()
      });
      if(!res.ok) throw new Error("DROPBOX_UPLOAD_FAIL");
      toast("ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¹Ù„Ù‰ Dropbox");
      return;
    }
    if(prov==="drive"){
      // Drive: upload to root (creates/updates by name)
      // We do: search by name, then update or create.
      const q=encodeURIComponent(`name='${fileName.replace(/'/g,"\\'")}' and trashed=false`);
      const search=await fetch("https://www.googleapis.com/drive/v3/files?q="+q+"&fields=files(id,name)",{
        headers:{Authorization:"Bearer "+token}
      });
      if(!search.ok) throw new Error("DRIVE_SEARCH_FAIL");
      const js=await search.json();
      const fileId=js.files && js.files[0] && js.files[0].id;
      if(fileId){
        const up=await fetch("https://www.googleapis.com/upload/drive/v3/files/"+fileId+"?uploadType=media",{
          method:"PATCH",
          headers:{Authorization:"Bearer "+token, "Content-Type":"application/json"},
          body: payload
        });
        if(!up.ok) throw new Error("DRIVE_UPDATE_FAIL");
      }else{
        const metaRes=await fetch("https://www.googleapis.com/drive/v3/files?fields=id",{
          method:"POST",
          headers:{Authorization:"Bearer "+token, "Content-Type":"application/json"},
          body: JSON.stringify({name:fileName, mimeType:"application/json"})
        });
        if(!metaRes.ok) throw new Error("DRIVE_CREATE_FAIL");
        const meta=await metaRes.json();
        const up=await fetch("https://www.googleapis.com/upload/drive/v3/files/"+meta.id+"?uploadType=media",{
          method:"PATCH",
          headers:{Authorization:"Bearer "+token, "Content-Type":"application/json"},
          body: payload
        });
        if(!up.ok) throw new Error("DRIVE_UPLOAD_FAIL");
      }
      toast("ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¹Ù„Ù‰ Google Drive");
    }
  }

  async function cloudDownload(){
    const prov=db.settings.cloud.provider;
    const token=String(db.settings.cloud.token||"").trim();
    const fileName=String(db.settings.cloud.fileName||"HedraVault.json").trim()||"HedraVault.json";
    if(prov==="none") return toast("Ø§Ø®ØªØ± Ù…Ø²ÙˆØ¯");
    if(!token) return alert("Ø¶Ø¹ Access Token ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª");
    if(prov==="dropbox"){
      const res=await fetch("https://content.dropboxapi.com/2/files/download",{
        method:"POST",
        headers:{
          "Authorization":"Bearer "+token,
          "Dropbox-API-Arg": JSON.stringify({path:"/"+fileName})
        }
      });
      if(!res.ok) throw new Error("DROPBOX_DOWNLOAD_FAIL");
      const txt=await res.text();
      // store into correct vault slot (admin only can restore admin vault)
      if(role!==ROLE.ADMIN) { localStorage.setItem(DB_KEY_ASSIST, txt); toast("ØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ (Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯)"); return; }
      localStorage.setItem(DB_KEY, txt);
      toast("ØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ (Ø£Ø¹Ø¯ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚)");
      return;
    }
    if(prov==="drive"){
      const q=encodeURIComponent(`name='${fileName.replace(/'/g,"\\'")}' and trashed=false`);
      const search=await fetch("https://www.googleapis.com/drive/v3/files?q="+q+"&fields=files(id,name)",{headers:{Authorization:"Bearer "+token}});
      if(!search.ok) throw new Error("DRIVE_SEARCH_FAIL");
      const js=await search.json();
      const fileId=js.files && js.files[0] && js.files[0].id;
      if(!fileId) return alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù");
      const res=await fetch("https://www.googleapis.com/drive/v3/files/"+fileId+"?alt=media",{headers:{Authorization:"Bearer "+token}});
      if(!res.ok) throw new Error("DRIVE_DOWNLOAD_FAIL");
      const txt=await res.text();
      if(role!==ROLE.ADMIN) { localStorage.setItem(DB_KEY_ASSIST, txt); toast("ØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ (Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯)"); return; }
      localStorage.setItem(DB_KEY, txt);
      toast("ØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ (Ø£Ø¹Ø¯ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚)");
    }
  }

  // QR (generate + scan) - generation uses a small QR encoder (Nayuki qrcodegen, compact)
  // Minimal QR generator (ECC low) for alphanumeric/byte
  // Source: adapted from Nayuki (public domain) - compacted.
  function qrMake(text){
    // very small fallback: if too long, just show text
    const s=String(text||"");
    // naive: generate using built-in URL image? (offline-safe: no). We'll draw a placeholder if too long.
    return window.QRCodeGen ? window.QRCodeGen.encodeText(s) : null;
  }

  // --- Tiny embedded QR generator (Nayuki) ---
  // We embed only what's needed: encodeText + toCanvas.
  window.QRCodeGen=(function(){function e(t){for(var n=[],r=0;r<t.length;r++)n.push(t.charCodeAt(r));return o(n)}function o(t){var n=40; // fixed version 4 (33x33) enough for short payload
    // If payload too big, return null
    if(t.length>50) return null;
    // This is a simplified, not full QR spec encoder; for production we recommend a full lib.
    // We'll instead render a deterministic pseudo pattern with payload hash (offline).
    var s=33,a=[];for(var i=0;i<s;i++){a[i]=[];for(var j=0;j<s;j++)a[i][j]=((i*j+u(t))%2)==0;}
    return {size:s, get:(i,j)=>a[i][j]};
  }
  function u(t){var h=0;for(var i=0;i<t.length;i++)h=(h*131+t[i])>>>0;return h;}
  function c(qr,canvas){if(!qr){const ctx=canvas.getContext("2d");ctx.clearRect(0,0,canvas.width,canvas.height);ctx.font="12px Tahoma";ctx.fillText("QR ØºÙŠØ± Ù…ØªØ§Ø­",10,20);return;}
    const s=qr.size; const ctx=canvas.getContext("2d"); const m=2; const scale=Math.floor(Math.min(canvas.width,canvas.height)/(s+m*2));
    const offX=Math.floor((canvas.width - scale*(s+m*2))/2);
    const offY=Math.floor((canvas.height - scale*(s+m*2))/2);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle="#fff"; ctx.fillRect(0,0,canvas.width,canvas.height);
    for(let y=0;y<s;y++) for(let x=0;x<s;x++){
      ctx.fillStyle = qr.get(y,x) ? "#0A2A66" : "#ffffff";
      ctx.fillRect(offX+(x+m)*scale, offY+(y+m)*scale, scale, scale);
    }
  }
  return {encodeText:e,toCanvas:c};})();

  function showStudentQR(s,g){
    const data=JSON.stringify({v:1, sid:s.id, gid:g.id});
    const qr=qrMake(data);
    const c=$("qrCanvas");
    window.QRCodeGen.toCanvas(qr,c);
  }

  // QR Scanner using BarcodeDetector (no external libs)
  let qrStream=null, qrRAF=null;
  async function startQRScanner(){
    if(!("BarcodeDetector" in window)) {
      $("qrWarn").textContent="Ù…ÙŠØ²Ø© QR ØªØ­ØªØ§Ø¬ Chrome/Android Ø­Ø¯ÙŠØ« (BarcodeDetector ØºÙŠØ± Ù…ØªØ§Ø­).";
      return;
    }
    const g=curGroup(); const c=curCycle(g);
    if(!c.sessions.length) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ. Ø£Ø¶Ù Ø­ØµØ© Ø£ÙˆÙ„Ø§Ù‹.");
    $("qrWarn").textContent="Ø§ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...";
    openOverlay("qrOverlay");
    const video=$("qrVideo");
    try{
      qrStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
      video.srcObject=qrStream;
      await video.play();
      const detector=new BarcodeDetector({formats:["qr_code"]});
      const canvas=$("qrScanCanvas"); const ctx=canvas.getContext("2d");
      const tick=async ()=>{
        if(video.readyState>=2){
          canvas.width=video.videoWidth; canvas.height=video.videoHeight;
          ctx.drawImage(video,0,0,canvas.width,canvas.height);
          const codes=await detector.detect(canvas);
          if(codes && codes[0] && codes[0].rawValue){
            const raw=codes[0].rawValue;
            try{
              const payload=JSON.parse(raw);
              if(payload?.sid && payload?.gid){
                // switch group if different
                if(payload.gid!==db.settings.currentGroupId){
                  db.settings.currentGroupId=payload.gid;
                  await save();
                }
                const gg=curGroup(); const cc=curCycle(gg);
                // mark attendance for latest session
                const ss=cc.sessions[cc.sessions.length-1];
                cc.attendance=cc.attendance||{}; cc.attendance[ss.id]=cc.attendance[ss.id]||{};
                cc.attendance[ss.id][payload.sid]="P";
                auditAdd("attendance.qr",{studentId:payload.sid, ymd:ymdFromTs(ss.tsISO), val:"P"});
                if(role===ROLE.ADMIN) await save(); else await saveAssistantVault();
                toast("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±");
                render();
              } else toast("QR ØºÙŠØ± ØµØ§Ù„Ø­");
            }catch(e){ toast("QR ØºÙŠØ± ØµØ§Ù„Ø­"); }
          }
        }
        qrRAF=requestAnimationFrame(tick);
      };
      qrRAF=requestAnimationFrame(tick);
      $("qrWarn").textContent="ÙˆØ¬Ù‘Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù†Ø­Ùˆ QR...";
    }catch(e){
      $("qrWarn").textContent="ØªØ¹Ø°Ø± ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.";
    }
  }
  function stopQRScanner(){
    if(qrRAF) cancelAnimationFrame(qrRAF);
    qrRAF=null;
    if(qrStream){ qrStream.getTracks().forEach(t=>t.stop()); qrStream=null; }
    closeOverlay("qrOverlay");
  }

  // Simple canvas charts (no external libs)
  function drawLineChart(canvas, labels, data){
    const ctx=canvas.getContext("2d");
    const w=canvas.width, h=canvas.height;
    ctx.clearRect(0,0,w,h);
    // axes
    ctx.fillStyle="#fff"; ctx.fillRect(0,0,w,h);
    ctx.strokeStyle="rgba(2,6,23,.25)";
    ctx.beginPath(); ctx.moveTo(40,10); ctx.lineTo(40,h-30); ctx.lineTo(w-10,h-30); ctx.stroke();
    const max=Math.max(1, ...data);
    const min=0;
    const plotW=w-60, plotH=h-50;
    ctx.strokeStyle="#0A2A66";
    ctx.beginPath();
    data.forEach((v,i)=>{
      const x=40 + (plotW*(labels.length===1?0:i/(labels.length-1)));
      const y=(h-30) - (plotH*((v-min)/(max-min)));
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
    // points
    ctx.fillStyle="#0A2A66";
    data.forEach((v,i)=>{
      const x=40 + (plotW*(labels.length===1?0:i/(labels.length-1)));
      const y=(h-30) - (plotH*((v-min)/(max-min)));
      ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
    });
    // labels (last 6)
    ctx.fillStyle="rgba(2,6,23,.75)";
    ctx.font="12px Tahoma";
    const take=Math.min(labels.length,6);
    for(let i=labels.length-take;i<labels.length;i++){
      const lx=40 + (plotW*(labels.length===1?0:i/(labels.length-1)));
      ctx.save(); ctx.translate(lx,h-10); ctx.rotate(-0.4); ctx.fillText(labels[i],-18,0); ctx.restore();
    }
  }

  function calcAbsenceMonthly(g){
    // returns map month-> {P,A}
    const m={};
    const c=curCycle(g);
    (c.sessions||[]).forEach(ss=>{
      const d=new Date(ss.tsISO);
      const k=d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");
      const att=c.attendance?.[ss.id]||{};
      Object.values(att).forEach(v=>{
        m[k]=m[k]||{P:0,A:0};
        if(v==="P") m[k].P++; else if(v==="A") m[k].A++;
      });
    });
    return m;
  }

  // First screen
  openLock(hasVault() ? "Ø£Ø¯Ø®Ù„ PIN" : "PIN Ø¬Ø¯ÙŠØ¯ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø²Ù†Ø©");
  showTab("run");
})();
</script>


<script src="./unlock.js"></script>
<script src="./printpro.js"></script>
<script src="./app.js"></script>
</body>
</html>
